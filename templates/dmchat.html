<!DOCTYPE html>
<html>
<head>
    <title>Direct Messages ‚Äî Secure Chat</title>
    <meta http-equiv="refresh" content="600">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#0f1724;--card:#0b1220;--accent:#5865F2;--muted:#93a2b8}
        body { margin:0;min-height:100vh;background:linear-gradient(135deg,var(--bg),#071028);font-family:Inter,system-ui,Arial;color:#e6eef8 }
        .chat-container{display:flex;height:100vh;gap:0}
        .sidebar{width:280px;background:linear-gradient(180deg,rgba(0,0,0,0.3),transparent);border-right:1px solid rgba(255,255,255,0.03);padding:14px;overflow-y:auto}
        .chat-main{flex:1;display:flex;flex-direction:column;padding:18px}
        .chat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
        .chat-header h3{color:var(--accent);margin:0}
        .btn-back{padding:8px 12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:8px;color:#e6eef8;text-decoration:none;font-size:13px;cursor:pointer}
        .btn-back:hover{background:rgba(88,101,242,0.08)}
        .chat-box{flex:1;overflow-y:auto;background:linear-gradient(180deg,#071022,#0b1224);padding:16px;border-radius:10px;margin-bottom:14px}
        .message{margin-bottom:12px;padding:10px 14px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:10px;animation:slideIn .2s ease}
        .message b{color:var(--accent);font-weight:700}
        .timestamp{color:var(--muted);font-size:11px;margin-left:8px}
        .delete-btn{background:none;border:none;color:#ff9a9a;cursor:pointer;font-size:16px;margin-left:8px}
        .chat-form{display:flex;gap:8px}
        input{flex:1;padding:10px;background:#071022;border:1px solid rgba(255,255,255,0.03);border-radius:8px;color:#e6eef8}
        button{padding:10px 16px;background:var(--accent);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all .12s ease}
        button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(88,101,242,0.2)}
        .info-box{padding:12px;background:rgba(88,101,242,0.1);border-radius:8px;color:var(--muted);font-size:13px;margin-bottom:14px}
        .dm-item{padding:8px;margin-bottom:6px;border-radius:6px;cursor:pointer;background:transparent;border:1px solid rgba(255,255,255,0.02)}
        .dm-item:hover{background:rgba(88,101,242,0.1)}
        .dm-item a{color:#e6eef8;text-decoration:none;display:block}
        .sidebar-title{color:var(--accent);font-weight:700;margin-bottom:12px;font-size:14px}
        @keyframes slideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    </style>
</head>

<body>
    <div class="chat-container">
        <div class="sidebar">
            <div class="sidebar-title">Direct Messages</div>
            <div id="dmList"></div>
            <a href="/search" class="btn-back" style="display:block;margin-top:14px">+ Search users</a>
        </div>
        <div class="chat-main">
            {% if not target %}
                <div class="info-box">Select a user from the DM list or search to start chatting.</div>
            {% else %}
                <div class="chat-header">
                    <h3>{{ target }}</h3>
                    <a href="/home" class="btn-back">‚Üê Home</a>
                </div>

                {% set users = [session['user'], target] | sort %}
                {% set room = users[0] ~ '|' ~ users[1] %}

                <div id="chatBox" class="chat-box">
                    {% for m in messages %}
                        <div class="message" id="msg-{{ m.id }}">
                            <b>{{ m.sender }}</b>: <span class="body">{{ m.message }}</span>
                            <span class="timestamp">({{ m.timestamp }})</span>
                            {% if session.role == "admin" %}
                                <button class="delete-btn" data-id="{{ m.id }}" title="Delete">‚úï</button>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <form id="sendForm" class="chat-form">
                    <input id="messageInput" type="text" placeholder="Send a message..." required>
                    <button type="submit">Send</button>
                </form>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const socket = io();
        const isAdmin = {{ 'true' if session.get('role') == 'admin' else 'false' }};

        // Load DM list
        fetch('/api/dms')
            .then(r => r.json())
            .then(data => {
                const dmList = document.getElementById('dmList');
                if (data.users && data.users.length) {
                    dmList.innerHTML = data.users.map(u => 
                        `<div class="dm-item"><a href="/dmchat?user=${u}">üí¨ ${u}</a></div>`
                    ).join('');
                }
            })
            .catch(e => console.error('Failed to load DMs:', e));

        {% if target %}
            const room = "{{ room }}";

            socket.emit('join', {room});

            socket.on('room_messages', data => {
                const chatBox = document.getElementById('chatBox');
                chatBox.innerHTML = '';
                if (data.messages && data.messages.length) {
                    data.messages.forEach(m => {
                        const el = document.createElement('div');
                        el.className = 'message';
                        el.id = `msg-${m.id}`;
                        el.innerHTML = `<b>${m.sender}</b>: <span class="body">${m.message}</span> <span class="timestamp">(${m.timestamp})</span>`;
                        if (isAdmin) {
                            const btn = document.createElement('button');
                            btn.className = 'delete-btn';
                            btn.dataset.id = m.id;
                            btn.innerText = '‚úï';
                            btn.title = 'Delete';
                            el.appendChild(btn);
                        }
                        chatBox.appendChild(el);
                    });
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            socket.on('new_message', m => {
                if (!m) return;
                const chatBox = document.getElementById('chatBox');
                const el = document.createElement('div');
                el.className = 'message';
                el.id = `msg-${m.id}`;
                el.innerHTML = `<b>${m.sender}</b>: <span class="body">${m.message}</span> <span class="timestamp">(${m.timestamp})</span>`;
                if (isAdmin) {
                    const btn = document.createElement('button');
                    btn.className = 'delete-btn';
                    btn.dataset.id = m.id;
                    btn.innerText = '‚úï';
                    btn.title = 'Delete';
                    el.appendChild(btn);
                }
                chatBox.appendChild(el);
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            socket.on('message_deleted', data => {
                const el = document.getElementById('msg-' + data.id);
                if (el) el.remove();
            });

            document.getElementById('sendForm').addEventListener('submit', e => {
                e.preventDefault();
                const input = document.getElementById('messageInput');
                const txt = input.value.trim();
                if (!txt) return;
                socket.emit('send_message', {room, message: txt});
                input.value = '';
            });

            document.getElementById('chatBox').addEventListener('click', e => {
                if (e.target && e.target.classList.contains('delete-btn')) {
                    const id = e.target.dataset.id;
                    socket.emit('delete_message', {id});
                }
            });
        {% endif %}
    </script>

</body>
</html>
